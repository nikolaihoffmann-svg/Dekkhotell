<!DOCTYPE html>
<html lang="no" data-theme="auto">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dekkhotell</title>
<style>
:root{--bg:#0c1016;--card:#151b24;--text:#f3f3f3;--muted:#9ca3af;--brand:#3a6df0;--ok:#24d65f;--danger:#ef4444;--border:#1e2633;--accent:#2ec4b6;--shadow:0 2px 6px rgba(0,0,0,.35)}
@media(prefers-color-scheme:light){:root[data-theme="auto"]{--bg:#f6f8fb;--card:#fff;--text:#0b0f14;--muted:#475569;--brand:#2463eb;--ok:#16a34a;--danger:#e11d48;--border:#e7eef6;--accent:#0ea5a0;--shadow:0 2px 10px rgba(16,24,40,.08)}}
:root[data-theme="light"]{--bg:#f6f8fb;--card:#fff;--text:#0b0f14;--muted:#475569;--brand:#2463eb;--ok:#16a34a;--danger:#e11d48;--border:#e7eef6;--accent:#0ea5a0;--shadow:0 2px 10px rgba(16,24,40,.08)}
:root[data-theme="dark"]{--bg:#0c1016;--card:#151b24;--text:#f3f3f3;--muted:#9ca3af;--brand:#3a6df0;--ok:#24d65f;--danger:#ef4444;--border:#1e2633;--accent:#2ec4b6;--shadow:0 2px 6px rgba(0,0,0,.35)}

*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;min-height:100vh;display:flex;flex-direction:column;transition:background .2s ease,color .2s ease}

/* Header */
header{background:var(--card);padding:10px 14px;display:flex;justify-content:space-between;align-items:center;gap:10px;border-bottom:1px solid var(--border);box-shadow:var(--shadow);position:sticky;top:0;z-index:10}
.brand{display:flex;align-items:center;gap:8px}
.logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--brand),var(--accent))}
.title{font-weight:800}
.tools{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
input[type="search"]{background:transparent;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:8px 12px;width:min(360px,46vw)}
.counter{color:var(--muted);font-size:.9rem}
select{background:transparent;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:8px 10px}
.btn{border:1px solid var(--border);background:transparent;color:var(--text);border-radius:999px;padding:8px 12px;cursor:pointer;transition:.15s}
.btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
.btn:hover{background:color-mix(in oklab,var(--brand) 14%,transparent)}
main{flex:1;padding:14px}

/* Kompaktliste */
.card.compact{background:var(--card);padding:10px 14px;border-radius:12px;margin-bottom:8px;cursor:pointer;border:1px solid var(--border);transition:background .2s ease,border-color .2s ease}
.card.compact.open{background:color-mix(in oklab,var(--brand) 6%,var(--card));border-color:color-mix(in oklab,var(--brand) 28%,var(--border))}
.card.compact .mainline{display:flex;justify-content:space-between;align-items:center;gap:8px}
.card.compact .left{display:flex;align-items:center;gap:8px;min-width:0}
.card.compact .reg{font-weight:800}
.card.compact .right{display:flex;align-items:center;gap:8px}
.badge{padding:3px 8px;border-radius:999px;font-size:.8rem;border:1px solid var(--border)}
.ok{background:color-mix(in oklab,var(--ok) 40%,transparent);color:#06260f;border-color:color-mix(in oklab,var(--ok) 60%,var(--border))}
.danger{background:color-mix(in oklab,var(--danger) 28%,transparent);color:#3b0b0b;border-color:color-mix(in oklab,var(--danger) 55%,var(--border))}
.card.compact .chev{display:inline-block;transition:transform .2s ease;opacity:.9}
.card.compact.open .chev{transform:rotate(180deg)}
.card.compact .details{border-top:1px solid var(--border);margin-top:6px;padding-top:6px;font-size:.95rem;overflow:hidden}
.meta{color:var(--muted);margin-top:3px}
.actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.actions button{border:1px solid var(--border);background:transparent;color:var(--text);border-radius:8px;padding:6px 10px;font-size:.85rem}
.actions .ok{background:var(--ok);border-color:var(--ok);color:#06260f}
.actions .danger{background:var(--danger);border-color:var(--danger);color:#fff}
.empty{color:var(--muted);text-align:center;margin-top:16px}

/* Dialog */
dialog{border:none;border-radius:12px;padding:18px 20px;background:var(--card);color:var(--text);max-width:520px;width:92%;box-shadow:var(--shadow);animation:pop .2s ease}
@keyframes pop{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
dialog::backdrop{background:rgba(0,0,0,.45)}
form{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
form .row-2{grid-column:1/-1}
label{font-size:.9rem;color:var(--muted)}
input,textarea{width:100%;padding:8px 10px;margin-top:4px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--text)}
textarea{resize:vertical;min-height:70px}
form .actions{grid-column:1/-1;display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end;margin-top:4px}

/* Hurtigvalg-bokser */
.quickbox{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.quickbox button{background:color-mix(in oklab,var(--brand) 12%,transparent);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:6px 10px;font-size:.85rem;cursor:pointer;transition:.15s}
.quickbox button:hover{background:var(--brand);color:#fff}

/* Flytende + Ny knapp */
.fab{position:fixed;right:14px;bottom:14px;z-index:20;background:var(--brand);color:#fff;border:none;border-radius:999px;padding:14px 16px;font-weight:700;box-shadow:var(--shadow)}
@media(max-width:640px){input[type="search"]{width:44vw}}
</style>
</head>

<body>
<header>
  <div class="brand"><div class="logo"></div><div class="title">Dekkhotell</div></div>
  <div class="tools">
    <button id="themeBtn" class="btn" title="Bytt tema">üåû/üåô</button>
    <input id="search" type="search" placeholder="S√∏k regnr, navn‚Ä¶" />
    <span id="count" class="counter"></span>

    <select id="labelPreset" title="Etikett-format">
      <option value="A4-50x30" selected>A4 ‚Äì 50√ó30 mm (3 kol)</option>
      <option value="DYMO-99012">DYMO 99012 ‚Äì 89√ó28 mm</option>
      <option value="DYMO-11354">DYMO 11354 ‚Äì 57√ó32 mm</option>
      <option value="DYMO-99014">DYMO 99014 ‚Äì 101√ó54 mm</option>
      <option value="BRO-DK11209">Brother DK-11209 ‚Äì 62√ó29 mm</option>
      <option value="BRO-DK11201">Brother DK-11201 ‚Äì 90√ó29 mm</option>
      <option value="BRO-DK11208">Brother DK-11208 ‚Äì 90√ó38 mm</option>
      <option value="BRO-DK22205">Brother DK-22205 ‚Äì 62 mm rull (kontinuerlig)</option>
    </select>

    <button id="printBtn" class="btn">üè∑Ô∏è Etiketter</button>
    <button id="exportBtn" class="btn">üì§ Eksporter</button>
    <button id="importBtn" class="btn">üì• Importer</button>
    <input id="importFile" type="file" accept="application/json" hidden>
    <button id="newBtn" class="btn primary">+ Ny</button>
  </div>
</header>

<main id="list"></main>
<div id="empty" class="empty" hidden>Ingen treff ‚Ä¶</div>
<button id="fab" class="fab">+ Ny</button>

<dialog id="editDlg">
  <h2 id="dlgTitle">Ny registrering</h2>
  <form id="editForm" autocomplete="on">
    <div><label>Regnr<input name="reg" required placeholder="FT31184"></label></div>
    <div><label>Kunde<input name="customer" placeholder="Ola Nordmann"></label></div>
    <div><label>Telefon<input name="phone" inputmode="tel" placeholder="90000000"></label></div>
    <div><label>Plassering<input name="location" placeholder="Reol A1"></label></div>
    <div><label>Merke<input name="brand" placeholder="Michelin"></label></div>
    <div><label>St√∏rrelse<input name="size" placeholder="205/55 R16"></label></div>
    <div>
      <label>Felg
        <input name="rims" placeholder="Alu / St√•l" id="rimsInput">
      </label>
      <div class="quickbox" id="rimsQuick">
        <button type="button">Alu</button>
        <button type="button">St√•l</button>
        <button type="button">Originale</button>
        <button type="button">Uoriginale</button>
      </div>
    </div>
    <div>
      <label>Sesong
        <input name="season" placeholder="Sommer / Vinter" id="seasonInput">
      </label>
      <div class="quickbox" id="seasonQuick">
        <button type="button">Sommerdekk</button>
        <button type="button">Piggfri vinterdekk</button>
        <button type="button">Piggdekk</button>
      </div>
    </div>
    <div class="row-2"><label>Notater<textarea name="notes" placeholder="M√∏nsterdybde, skader ‚Ä¶"></textarea></label></div>
    <div class="actions">
      <button type="button" id="cancelEdit" class="btn">Avbryt</button>
      <button type="submit" class="btn primary" style="background:var(--brand);color:#fff;border-color:var(--brand)">Lagre</button>
    </div>
  </form>
</dialog>

<script>
/* Tema-bryter */
(function(){
  const key='dekk.theme';
  const btn=document.getElementById('themeBtn');
  function setTheme(v){ document.documentElement.setAttribute('data-theme',v); localStorage.setItem(key,v);
    btn.textContent = v==='dark'?'üåô' : (v==='light'?'üåû' : 'üåû/üåô'); }
  setTheme(localStorage.getItem(key)||'auto');
  btn.addEventListener('click',()=>{
    const cur=document.documentElement.getAttribute('data-theme')||'auto';
    const next = cur==='auto' ? 'dark' : (cur==='dark' ? 'light' : 'auto');
    setTheme(next);
  });
})();

/* Data & lagring */
let rows = JSON.parse(localStorage.getItem('dekk.rows')||'[]');
if(!rows.length){
  rows = [
    {id:crypto.randomUUID?.()||'1',reg:'FT31184',customer:'Ola Nordmann',phone:'90012345',location:'Reol A1',
     brand:'Michelin',size:'205/55 R16',rims:'Alu',season:'Sommerdekk',notes:'God stand',
     status:'inn',checkIn:'2025-03-10',checkOut:'',updatedAt:new Date().toISOString()}
  ];
  localStorage.setItem('dekk.rows', JSON.stringify(rows));
}
const save=()=>localStorage.setItem('dekk.rows', JSON.stringify(rows));

/* UI-elementer */
const listEl=document.getElementById('list');
const emptyEl=document.getElementById('empty');
const countEl=document.getElementById('count');
const searchEl=document.getElementById('search');
const labelPresetEl=document.getElementById('labelPreset');
const newBtn=document.getElementById('newBtn');
const fab=document.getElementById('fab');
const exportBtn=document.getElementById('exportBtn');
const importBtn=document.getElementById('importBtn');
const importFile=document.getElementById('importFile');
const printBtn=document.getElementById('printBtn');

const editDlg=document.getElementById('editDlg');
const editForm=document.getElementById('editForm');
const dlgTitle=document.getElementById('dlgTitle');
let editTarget=null;

/* Hjelpere */
const fmt=(d)=>!d?'-':new Date(d).toLocaleDateString('no-NO');
const matches=(r)=>{const q=searchEl.value.trim().toLowerCase(); if(!q) return true;
  return [r.reg,r.customer,r.size,r.brand,r.location,r.season,r.rims].some(v=>(v||'').toLowerCase().includes(q));};
searchEl.addEventListener('input', render);

function slideDown(el){el.hidden=false;el.style.maxHeight='0px';el.style.transition='max-height .2s ease';
  requestAnimationFrame(()=>{el.style.maxHeight=el.scrollHeight+'px';});
  el.addEventListener('transitionend',()=>{el.style.maxHeight='';el.style.transition='';},{once:true});}
function slideUp(el){el.style.maxHeight=el.scrollHeight+'px';el.style.transition='max-height .2s ease';
  requestAnimationFrame(()=>{el.style.maxHeight='0px';});
  el.addEventListener('transitionend',()=>{el.hidden=true;el.style.maxHeight='';el.style.transition='';},{once:true});}

/* Render */
function render(){
  const filtered=rows.filter(matches);
  countEl.textContent = filtered.length ? `${filtered.length} treff` : '';
  listEl.innerHTML=''; emptyEl.hidden = filtered.length>0;

  for(const r of filtered){
    const card=document.createElement('article'); card.className='card compact'; card.dataset.id=r.id;

    const header=document.createElement('div'); header.className='row mainline';
    header.innerHTML=`
      <div class="left">üöó <span class="reg">${r.reg||'Ukjent'}</span> ¬∑ ${r.customer||''}</div>
      <div class="right"><span class="muted">${r.size||''}</span>
        <span class="badge ${r.status==='inn'?'ok':'danger'}">${r.status==='inn'?'INN':'UT'}</span>
        <span class="chev">‚ñæ</span></div>`;

    const details=document.createElement('div'); details.className='details'; details.hidden=true;
    details.innerHTML=`
      <div class="meta">üìû ${r.phone||'-'} ¬∑ üìç ${r.location||'-'}</div>
      <div class="meta">üõû ${r.season||'-'} ¬∑ Felg: ${r.rims||'-'}</div>
      <div class="meta">Merk: ${r.brand||'-'} ¬∑ ${r.size||'-'}</div>
      <div class="meta">Oppdatert: ${fmt(r.updatedAt)}</div>
      ${r.notes?`<div class="meta">üìù ${r.notes}</div>`:''}
      <div class="actions">
        <button class="ghost edit">‚úèÔ∏è Rediger</button>
        <button class="${r.status==='inn'?'danger':'ok'} toggle">${r.status==='inn'?'‚§¥Ô∏è Marker UT':'‚§µÔ∏è Marker INN'}</button>
        <button class="danger del">üóëÔ∏è Slett</button>
      </div>`;

    header.addEventListener('click',()=>{ const open=!details.hidden; if(open){slideUp(details);card.classList.remove('open');} else {slideDown(details);card.classList.add('open');} });

    details.querySelector('.toggle').addEventListener('click',(e)=>{e.stopPropagation();
      r.status = r.status==='inn'?'ut':'inn'; r.updatedAt=new Date().toISOString(); save(); render();});
    details.querySelector('.del').addEventListener('click',(e)=>{e.stopPropagation();
      if(confirm('Slette denne?')){ rows = rows.filter(x=>x.id!==r.id); save(); render(); }});
    details.querySelector('.edit').addEventListener('click',(e)=>{e.stopPropagation(); openEdit(r); });

    card.append(header,details); listEl.append(card);
  }
}

/* Ny/Rediger + hurtigvalg */
function openEdit(r){
  editTarget = r || null;
  dlgTitle.textContent = r ? 'Rediger registrering' : 'Ny registrering';
  editForm.reset();
  if(r){ for(const el of editForm.elements){ if(el.name && r[el.name]!=null) el.value = r[el.name]; } }
  editDlg.showModal();

  setupQuickFill('rimsQuick','rimsInput');
  setupQuickFill('seasonQuick','seasonInput');
}
function setupQuickFill(boxId, inputId){
  const box=document.getElementById(boxId);
  const input=document.getElementById(inputId);
  if(!box || !input) return;
  box.querySelectorAll('button').forEach(btn=>{
    btn.onclick=()=>{ input.value=btn.textContent; input.focus(); };
  });
}
document.getElementById('cancelEdit').addEventListener('click', ()=> editDlg.close());
document.getElementById('newBtn').addEventListener('click', ()=> openEdit(null));
document.getElementById('fab').addEventListener('click', ()=> openEdit(null));
editForm.addEventListener('submit',(e)=>{
  e.preventDefault();
  const data = Object.fromEntries(new FormData(editForm).entries());
  data.reg = (data.reg||'').trim().toUpperCase();
  if(editTarget){ Object.assign(editTarget, data, { updatedAt:new Date().toISOString() }); }
  else{
    rows.unshift({
      id: crypto.randomUUID?.() || ('id-'+Date.now()),
      ...data, status:'inn',
      checkIn:new Date().toISOString(), checkOut:'',
      updatedAt:new Date().toISOString()
    });
  }
  save(); editDlg.close(); render();
});

/* Eksport / Import (JSON) */
exportBtn.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(rows,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `dekkhotell-backup-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
});
importBtn.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', async ()=>{
  const f = importFile.files?.[0]; if(!f) return;
  try{
    const data = JSON.parse(await f.text());
    if(!Array.isArray(data)) throw new Error('Forventer en liste ([])');
    const norm = (o)=>({
      id: o.id || (crypto.randomUUID?.()||('id-'+Date.now()+Math.random().toString(36).slice(2))),
      reg: (o.reg||'').toString().trim().toUpperCase(),
      customer: o.customer||'', phone: o.phone||'', location: o.location||'',
      brand: o.brand||'', size: o.size||'', rims: o.rims||'', season: o.season||'',
      notes: o.notes||'', status: (o.status==='ut')?'ut':'inn',
      checkIn: o.checkIn||'', checkOut: o.checkOut||'', updatedAt: o.updatedAt||new Date().toISOString()
    });
    const incoming = data.map(norm);
    const map = new Map(rows.map(r=>[r.id, r]));
    const byReg = new Map(rows.map(r=>[r.reg, r]));
    for(const r of incoming){
      if(map.has(r.id)){ const old=map.get(r.id); map.set(r.id, (r.updatedAt>(old.updatedAt||''))?r:old); }
      else if(r.reg && byReg.has(r.reg)){ const old=byReg.get(r.reg); const keep = (r.updatedAt>(old.updatedAt||''))?r:old; map.set(keep.id, keep); }
      else { map.set(r.id, r); }
    }
    rows = Array.from(map.values()).sort((a,b)=>(b.updatedAt||'').localeCompare(a.updatedAt||''));
    save(); render(); alert(`Importert ${incoming.length} rader ‚úîÔ∏è`);
  }catch(err){ alert('Import feilet: ' + err.message); }
  finally{ importFile.value=''; }
});

/* ====== Etikett-presets (mm) ====== */
const LABEL_PRESETS = {
  "A4-50x30":   { type:"sheet", page:"A4", cols:3, margin:8, gap:6, w:50, h:30 },
  "DYMO-99012": { type:"roll",  w:89, h:28, margin:2, gap:2, cols:1 },
  "DYMO-11354": { type:"roll",  w:57, h:32, margin:2, gap:2, cols:1 },
  "DYMO-99014": { type:"roll",  w:101, h:54, margin:2, gap:2, cols:1 },
  "BRO-DK11209":{ type:"roll",  w:62, h:29, margin:2, gap:2, cols:1 },
  "BRO-DK11201":{ type:"roll",  w:90, h:29, margin:2, gap:2, cols:1 },
  "BRO-DK11208":{ type:"roll",  w:90, h:38, margin:2, gap:2, cols:1 },
  "BRO-DK22205":{ type:"roll",  w:62, h:30, margin:2, gap:2, cols:1 }
};

/* ===== Strekkode (Code128-B) offline ===== */
const CODE128_PATTERNS = [
"212222","222122","222221","121223","121322","131222","122213","122312","132212","221213",
"221312","231212","112232","122132","122231","113222","123122","123221","223211","221132",
"221231","213212","223112","312131","311222","321122","321221","312212","322112","322211",
"212123","212321","232121","111323","131123","131321","112313","132113","132311","211313",
"231113","231311","112133","112331","132131","113123","113321","133121","313121","211331",
"231131","213113","213311","213131","311123","311321","331121","312113","312311","332111",
"314111","221411","431111","111224","111422","121124","121421","141122","141221","112214",
"112412","122114","122411","142112","142211","241211","221114","413111","241112","134111",
"111242","121142","121241","114212","124112","124211","411212","421112","421211","212141",
"214121","412121","111143","111341","131141","114113","114311","411113","411311","113141",
"114131","311141","411131","211412","211214","211232","2331112"
];
const CODE128_START_B=104, CODE128_STOP=106;
function code128Svg(text){
  if(!text) text=" ";
  const codes=[];
  for(const ch of text){const c=ch.charCodeAt(0);codes.push((c>=32&&c<=126)?(c-32):("?".charCodeAt(0)-32));}
  let checksum=CODE128_START_B; for(let i=0;i<codes.length;i++) checksum+=codes[i]*(i+1); checksum%=103;
  const seq=[CODE128_START_B,...codes,checksum,CODE128_STOP];
  let x=0, bars=[];
  for(const pat of seq.map(i=>CODE128_PATTERNS[i])){
    let black=true;
    for(const d of pat){const w=+d;if(black)bars.push(`<rect x="${x}" y="0" width="${w}" height="60"/>`);x+=w;black=!black;}
  }
  return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${x} 60" preserveAspectRatio="none"><g fill="#000">${bars.join("")}</g></svg>`;
}

/* ===== QR-kode (v1, ECC M, alfanumerisk) offline ===== */
const QR_ALNUM = new Map([...("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ $%*+-./:").split("").entries()].map(([i,c])=>[c,i]));
const GF_EXP = new Uint8Array(512), GF_LOG = new Uint8Array(256);
(function initGF(){let x=1;for(let i=0;i<255;i++){GF_EXP[i]=x;GF_LOG[x]=i;x<<=1;if(x&0x100)x^=0x11D;}for(let i=255;i<512;i++)GF_EXP[i]=GF_EXP[i-255];})();
function gfMul(a,b){ if(a===0||b===0) return 0; return GF_EXP[(GF_LOG[a]+GF_LOG[b])%255]; }
function rsGeneratorPoly(deg){let p=[1];for(let i=0;i<deg;i++){const n=[];for(let j=0;j<p.length;j++)n[j]=gfMul(p[j],1);n.push(0);for(let j=0;j<p.length;j++)n[j]^=gfMul(p[j],GF_EXP[i]);p=n;}return p;}
function rsComputeECC(data, ecLen){const gen=rsGeneratorPoly(ecLen);const res=new Uint8Array(ecLen);
  for(const d of data){const f=d^res[0];res.copyWithin(0,1);res[res.length-1]=0;if(f!==0)for(let i=0;i<ecLen;i++)res[i]^=gfMul(gen[i],f);}return res;}
class BitBuf{constructor(){this.bits=[];}put(v,l){for(let i=l-1;i>=0;i--)this.bits.push((v>>>i)&1);}toBytes(){const o=[];for(let i=0;i<this.bits.length;i+=8){let b=0;for(let j=0;j<8&&i+j<this.bits.length;j++)b=(b<<1)|this.bits[i+j];o.push(b);}return Uint8Array.from(o);}get length(){return this.bits.length;}}
function makeQrV1M_alnum(text){
  text=(text||"").toString().toUpperCase();
  for(const ch of text) if(!QR_ALNUM.has(ch)) throw new Error("QR st√∏tter A‚ÄìZ, 0‚Äì9 og ' $%*+-./:'");
  if(text.length>20) throw new Error("For langt for QR v1-M");
  const bb=new BitBuf(); bb.put(0b0010,4); bb.put(text.length,9);
  for(let i=0;i<text.length;i+=2){
    if(i+1<text.length){const v=45*QR_ALNUM.get(text[i])+QR_ALNUM.get(text[i+1]); bb.put(v,11);}
    else{bb.put(QR_ALNUM.get(text[i]),6);}
  }
  const TOTAL_DATA_BYTES=16, TOTAL_DATA_BITS=TOTAL_DATA_BYTES*8;
  const remain=TOTAL_DATA_BITS-bb.length; bb.put(0, Math.min(4, Math.max(0, remain)));
  while(bb.length%8) bb.put(0,1);
  let data=Array.from(bb.toBytes()); const PAD=[0xEC,0x11]; for(let i=0;data.length<TOTAL_DATA_BYTES;i++) data.push(PAD[i&1]);
  data=Uint8Array.from(data); const ecc=rsComputeECC(data,10); const cw=[...data,...ecc];
  const n=21,m=Array.from({length:n},()=>Array(n).fill(null));
  function setFinder(r,c){for(let y=-1;y<=7;y++)for(let x=-1;x<=7;x++){const rr=r+y,cc=c+x;if(rr<0||cc<0||rr>=n||cc>=n)continue;
    const on=(x>=0&&x<=6&&y>=0&&y<=6)&&(x===0||x===6||y===0||y===6||(x>=2&&x<=4&&y>=2&&y<=4)); m[rr][cc]=on?1:0;}}
  setFinder(0,0);setFinder(0,n-7);setFinder(n-7,0);
  for(let i=8;i<n-8;i++){m[6][i]=(i%2)?0:1; m[i][6]=(i%2)?0:1;}
  m[8][n-8]=1; (function reserve(){for(let i=0;i<9;i++){if(i!==6){m[8][i]=m[8][i]??0; m[i][8]=m[i][8]??0;}}for(let i=n-8;i<n;i++){m[8][i]=m[8][i]??0; m[i][8]=m[i][8]??0;}})();
  let byteIdx=0, bitPos=7; function nextBit(){const b=(cw[byteIdx]>>bitPos)&1; if(--bitPos<0){bitPos=7;byteIdx++;} return b;}
  for(let col=n-1;col>0;col-=2){ if(col===6) col--; let upward=((n-1-col)%4)===0;
    for(let row=0;row<n;row++){const r=upward?(n-1-row):row; for(let cOff=0;cOff<2;cOff++){const c=col-cOff; if(m[r][c]!==null) continue; m[r][c]=(byteIdx<cw.length)?nextBit():0;}}}
  for(let r=0;r<n;r++)for(let c=0;c<n;c++){ if(m[r][c]===null) continue; if(((r+c)&1)===0) m[r][c]^=1; }
  function writeFormat(val){for(let i=0;i<6;i++)m[i][8]=(val>>(14-i))&1; m[7][8]=(val>>8)&1; m[8][8]=(val>>7)&1; m[8][7]=(val>>6)&1; for(let i=0;i<6;i++)m[8][5-i]=(val>>(5-i))&1;
    for(let i=0;i<8;i++) m[8][n-1-i]=(val>>(14-i))&1; for(let i=0;i<7;i++) m[n-1-i][8]=(val>>(i))&1;}
  const eccBits=0b00, maskBits=0b000; let fmt5=(eccBits<<3)|maskBits; let v=fmt5<<10, poly=0x537; for(let i=14;i>=10;i--){ if(v&(1<<i)) v^=(poly<<(i-10)); }
  writeFormat(((fmt5<<10)|v)^0x5412); return m;
}
function qrToSvg(matrix){
  const n=matrix.length; let rects=[];
  for(let y=0;y<n;y++){ let run=-1; for(let x=0;x<n;x++){ if(matrix[y][x]===1&&run<0)run=x;
    if((matrix[y][x]!==1||x===n-1)&&run>=0){ const end=(matrix[y][x]===1&&x===n-1)?x+1:x; rects.push(`<rect x="${run}" y="${y}" width="${end-run}" height="1"/>`); run=-1; } } }
  return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${n} ${n}" preserveAspectRatio="none"><g fill="#000">${rects.join("")}</g></svg>`;
}
function esc(s){return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}

/* Utskrift: QR (venstre) + Code128 (h√∏yre). NB: script-tag i string er escaped */
printBtn.addEventListener('click', ()=>{
  const preset = LABEL_PRESETS[labelPresetEl.value] || LABEL_PRESETS["A4-50x30"];
  const data = rows.map(r=>({reg:r.reg||'', customer:r.customer||''}));

  const labelsHtml = data.map(r=>{
    let qrSvg=""; try{ qrSvg = qrToSvg(makeQrV1M_alnum((r.reg||"").toUpperCase())); }catch(e){ qrSvg = `<svg></svg>`; }
    const bcSvg = code128Svg(r.reg||"");
    return `<div class="label">
      <div class="line">
        <div class="qr">${qrSvg}</div>
        <div class="bc">${bcSvg}</div>
      </div>
      <div class="text">
        <div class="reg">${esc(r.reg)}</div>
        <div class="cust">${esc(r.customer)}</div>
      </div>
    </div>`;
  }).join("");

  const isSheet = preset.type==="sheet";
  const pageDecl = isSheet && preset.page ? `@page { size: ${preset.page}; margin: ${preset.margin||8}mm; }` : `@page { margin: ${preset.margin||2}mm; }`;
  const gridCols = isSheet ? `repeat(${preset.cols||3}, 1fr)` : `repeat(${preset.cols||1}, 1fr)`;
  const qrSize = Math.min(14, Math.floor(preset.h-10)); // mm
  const bcHeight = Math.max(12, Math.min(preset.h-10, 18)); // mm

  const html = `<!DOCTYPE html><html lang="no"><head><meta charset="utf-8"><title>Etiketter ‚Äì ${esc(labelPresetEl.options[labelPresetEl.selectedIndex].text)}</title>
  <style>
    ${pageDecl}
    *{box-sizing:border-box}
    body{ font-family: system-ui, -apple-system, Segoe UI, sans-serif; background:#fff; color:#111; }
    .controls{ margin:4mm 0; }
    .grid{ display:grid; grid-template-columns:${gridCols}; gap:${preset.gap||2}mm; }
    .label{
      width:${preset.w}mm; height:${preset.h}mm;
      border:1px solid #e5e7eb; border-radius:6px; padding:2.5mm;
      display:flex; flex-direction:column; justify-content:space-between; background:#fff;
    }
    .line{ display:flex; align-items:center; gap:2mm; }
    .qr{ width:${qrSize}mm; height:${qrSize}mm; display:flex; align-items:center; justify-content:center; }
    .qr svg{ width:100%; height:100%; }
    .bc{ flex:1; height:${bcHeight}mm; display:flex; align-items:center; }
    .bc svg{ width:100%; height:100%; }
    .text{ font-size:11px; line-height:1.1; margin-top:1mm; display:flex; justify-content:space-between; gap:4mm; }
    .reg{ font-weight:700; }
    .cust{ color:#374151; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .hint{ font-size:12px; color:#6b7280; }
    @media print { .controls{ display:none; } body{ margin:0; } }
  </style>
  </head>
  <body>
    <div class="controls">
      <strong>${esc(labelPresetEl.options[labelPresetEl.selectedIndex].text)}</strong>
      <span class="hint"> ‚Äì velg samme papirst√∏rrelse/etikettrull i skriverinnstillingene.</span>
      <div style="margin:6px 0;"><button onclick="window.print()">Skriv ut</button> <button onclick="window.close()">Lukk</button></div>
      <hr/>
    </div>
    <div class="grid">${labelsHtml}</div>
    <script>window.addEventListener('load', ()=> setTimeout(()=>window.print(), 300));<\/script>
  </body></html>`;

  const w = window.open("", "_blank"); w.document.open(); w.document.write(html); w.document.close();
});

/* Start */
function init(){ render(); }
init();
</script>
</body>
</html>
